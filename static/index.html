<!DOCTYPE html>
<html>
<head>
    <title>Command Control</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: auto; }
        input, button { font-family: monospace; padding: 5px; margin: 5px; }
        #command { width: 400px; }
        #output { background: #f0f0f0; padding: 10px; margin-top: 20px; white-space: pre-wrap; }
        .command-item { border-bottom: 1px solid #ccc; padding: 10px 0; }
        .status { font-weight: bold; }
        .pending { color: orange; }
        .running { color: blue; }
        .completed { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>Command Control Panel <span id="version" style="float: right; color: #666; font-size: 14px;">Version: <span id="versionNumber">loading...</span></span></h2>
    <div>
        <input type="text" id="command" placeholder="Enter command (e.g., ls -la)">
        <button onclick="submitCommand()">Submit</button>
        <button onclick="refreshCommands()">Refresh</button>
    </div>
    <div id="output"></div>
    
    <script>
        // Command history tracking
        let commandHistory = JSON.parse(localStorage.getItem('commandHistory') || '[]');
        let historyIndex = commandHistory.length;
        let tempCommand = '';
        
        // Fetch version on load
        async function fetchVersion() {
            try {
                const response = await fetch('/version');
                const data = await response.json();
                document.getElementById('versionNumber').textContent = data.version;
            } catch (e) {
                document.getElementById('versionNumber').textContent = 'unknown';
            }
        }
        
        async function submitCommand() {
            const input = document.getElementById('command');
            const command = input.value.trim();
            
            const response = await fetch('/commands', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({command})
            });
            
            if (response.ok) {
                // Add to history if not duplicate
                if (command && command !== commandHistory[commandHistory.length - 1]) {
                    commandHistory.push(command);
                    localStorage.setItem('commandHistory', JSON.stringify(commandHistory));
                }
                historyIndex = commandHistory.length;
                input.value = '';
                refreshCommands();
            }
        }
        
        async function refreshCommands() {
            const response = await fetch('/commands');
            const commands = await response.json();
            
            const output = document.getElementById('output');
            output.innerHTML = '<h3>Commands:</h3>';
            
            commands.forEach(task => {
                const div = document.createElement('div');
                div.className = 'command-item';
                div.innerHTML = 
                    '<div><strong>ID:</strong> ' + task.pid + '</div>' +
                    '<div><strong>Command:</strong> ' + task.command + '</div>' +
                    '<div class="status ' + task.status + '"><strong>Status:</strong> ' + task.status + '</div>' +
                    (task.output ? '<div><strong>Output:</strong><pre>' + task.output + '</pre></div>' : '') +
                    (task.error ? '<div class="error"><strong>Error:</strong> ' + task.error + '</div>' : '');
                output.appendChild(div);
            });
        }
        
        // Keyboard navigation for command history
        document.getElementById('command').addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    // Save current input if starting navigation
                    if (historyIndex === commandHistory.length) {
                        tempCommand = this.value;
                    }
                    historyIndex--;
                    this.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    this.value = commandHistory[historyIndex];
                } else if (historyIndex === commandHistory.length - 1) {
                    // Restore temp command when reaching end
                    historyIndex++;
                    this.value = tempCommand;
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                submitCommand();
            } else {
                // Reset index on any other key
                historyIndex = commandHistory.length;
            }
        });
        
        // Auto-refresh every 2 seconds
        setInterval(refreshCommands, 2000);
        refreshCommands();
        fetchVersion();
    </script>
</body>
</html>
